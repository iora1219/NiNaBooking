<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å‚™ç”¨é ç´„å…¥å£</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@500&display=swap" rel="stylesheet">

<style>
  :root {
    --primary: #4361ee;
    --bg-color: #f0f2f5;
    --card-bg: #ffffff;
    --text-main: #2d3436;
    --slot-empty-bg: #e8f5e9;
    --slot-empty-text: #2e7d32;
    --slot-empty-border: #a5d6a7;
    --slot-full-bg: #ffebee;
    --slot-full-text: #c62828;
    --slot-full-border: #ef9a9a;
    --slot-locked-bg: #e9ecef;
  }

  body { font-family: 'Roboto', 'Noto Sans TC', sans-serif; padding: 20px; background-color: var(--bg-color); color: var(--text-main); margin: 0; }
  
  /* --- é ‚éƒ¨å°è¦½åˆ— --- */
  .navbar {
    display: flex; justify-content: space-between; align-items: center;
    background: var(--card-bg); padding: 15px 25px; border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px;
    flex-wrap: wrap; gap: 15px;
  }
  .nav-title { font-size: 1.5rem; font-weight: 700; color: #333; display: flex; align-items: center; gap: 10px; }
  .nav-controls { display: flex; gap: 10px; align-items: center; }

  /* --- ç‹€æ…‹æ¨™ç±¤ --- */
  .status-pill {
    padding: 6px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 600;
    display: inline-flex; align-items: center; gap: 5px;
  }
  .pill-blue { background: #e3f2fd; color: #1565c0; }
  .pill-green { background: #e8f5e9; color: #2e7d32; }
  .pill-red { background: #ffebee; color: #c62828; }

  /* --- æœå°‹æ¡† --- */
  .search-wrapper { position: relative; }
  .search-wrapper input {
    padding: 10px 15px; padding-left: 35px; border: 2px solid #e0e0e0;
    border-radius: 25px; outline: none; transition: all 0.3s; width: 180px; font-size: 14px;
  }
  .search-wrapper input:focus { border-color: var(--primary); width: 220px; box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15); }
  .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; font-size: 14px; }

  /* --- è¡¨æ ¼å€å¡Š --- */
  .table-card {
    background: var(--card-bg); border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    overflow: hidden; padding: 10px;
  }
  .table-scroll { overflow-x: auto; max-height: 80vh; } 

  table { width: 100%; border-collapse: separate; border-spacing: 6px; }

  th {
    background: #34495e; color: #fff; padding: 15px; text-align: center;
    font-weight: 600; border-radius: 6px;
    position: sticky; top: 0; z-index: 5;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  
  .time-col {
    background: #f8f9fa; color: #333; font-weight: 700; font-size: 0.9rem;
    padding: 0 15px; border-radius: 6px; border: 1px solid #dee2e6;
  }

  /* --- æ ¼å­æ¨£å¼ --- */
  .slot {
    height: 50px; min-width: 100px;
    text-align: center; font-size: 1rem; font-weight: 500;
    border-radius: 8px; border: 2px solid transparent; 
    cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative; box-shadow: 0 2px 0 rgba(0,0,0,0.05);
  }
  
  .slot:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .slot:active { transform: translateY(0); }

  /* 1. ç©ºä½ (ä¹¾æ·¨ç¶ è‰²ï¼Œç§»é™¤åŠ è™Ÿ) */
  .empty {
    background-color: var(--slot-empty-bg);
    color: var(--slot-empty-text);
    border-color: var(--slot-empty-border);
  }
  .empty:hover { background-color: #c8e6c9; }

  /* 2. å·²æ»¿ */
  .full {
    background-color: var(--slot-full-bg);
    color: var(--slot-full-text);
    border-color: var(--slot-full-border);
    font-weight: 700;
  }
  .full:hover { background-color: #ffcdd2; }

  /* 3. é–å®š */
  .locked-sys {
    background-color: var(--slot-locked-bg);
    color: #adb5bd;
    border-color: #dee2e6;
    cursor: not-allowed;
    background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(0,0,0,0.03) 5px, rgba(0,0,0,0.03) 10px);
    box-shadow: none;
  }
  .locked-sys:hover { transform: none; }
  .locked-sys::after { content: "ğŸ”’"; font-size: 0.8rem; opacity: 0.4; }

  /* 4. æœå°‹é«˜äº® */
  .highlight {
    background-color: #fff9c4 !important;
    color: #f57f17 !important;
    border-color: #fbc02d !important;
    box-shadow: 0 0 15px #fbc02d;
    z-index: 10;
    animation: pop 0.5s ease-in-out infinite alternate;
  }
  @keyframes pop { from { transform: scale(1); } to { transform: scale(1.05); } }

  .admin-mode .full { cursor: text; border-style: dashed; border-width: 2px; }

  /* æŒ‰éˆ• */
  .btn {
    padding: 8px 16px; border: none; border-radius: 20px;
    font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 14px;
  }
  .btn-primary { background: #4361ee; color: #fff; }
  .btn-primary:hover { background: #3f37c9; }
  .btn-outline { background: transparent; border: 1px solid #ccc; color: #666; }
  .btn-outline:hover { border-color: #4361ee; color: #4361ee; }
  .btn-active { background: #4361ee; color: #fff; border-color: #4361ee; }

  /* Toast */
  #toast {
    visibility: hidden; min-width: 280px; background-color: #333; color: #fff; text-align: center;
    border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px;
    transform: translateX(-50%) translateY(20px); font-size: 15px; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    opacity: 0; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
  }
  #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }

  #loading { 
    position: fixed; top:0; left:0; width:100%; height:100%; 
    background: rgba(255,255,255,0.9); z-index: 2000;
    display: flex; justify-content: center; align-items: center;
    flex-direction: column; color: #4361ee; font-weight: bold;
  }
</style>
</head>
<body>

<div id="loading">
  <div style="font-size: 2rem; margin-bottom: 10px;">â³</div>
  <div>è³‡æ–™åº«é€£ç·šä¸­...</div>
</div>

<div class="navbar">
  <div class="nav-title">
    ğŸ“… é ç´„å¾Œå°
    <button id="admin-btn" class="btn btn-outline" onclick="toggleAdmin()">ç®¡ç†å“¡</button>
  </div>
  
  <div class="nav-controls">
    <div id="current-date" class="status-pill pill-blue">-- å¹´ -- æœˆ</div>
    <div id="system-status" class="status-pill pill-red">è¼‰å…¥ä¸­...</div>

    <div class="search-wrapper">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="searchInput" placeholder="æœå°‹åå­—..." onkeyup="searchName()">
    </div>
    
    <button class="btn btn-primary" onclick="window.location.reload()">é‡æ–°æ•´ç†</button>
  </div>
</div>

<div class="table-card">
  <div class="table-scroll">
    <table id="booking-table">
      <thead><tr id="headRow"><th>æ™‚æ®µ</th></tr></thead>
      <tbody id="bodyRows"></tbody>
    </table>
  </div>
</div>

<div id="toast">æç¤ºè¨Šæ¯</div>

<script>
// ==========================================
// â˜… Firebase è¨­å®š â˜…
// ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyDPUz-JfM4eowCS2sjq_bkUaOShrm8OFvc",
  authDomain: "booking-2868f.firebaseapp.com",
  databaseURL: "https://booking-2868f-default-rtdb.firebaseio.com", 
  projectId: "booking-2868f",
  storageBucket: "booking-2868f.firebasestorage.app",
  messagingSenderId: "508038962872",
  appId: "1:508038962872:web:d4776dc98bb3706e905e4d",
  measurementId: "G-XEB4SCVVG2"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const weekdayName = n => ["(æ—¥)","(ä¸€)","(äºŒ)","(ä¸‰)","(å››)","(äº”)","(å…­)"][n];
const defaultTimeslots = ["13:00~13:30","13:35~14:05","14:10~14:40","14:45~15:15","15:20~15:50","15:55~16:25","16:30~17:00"];
let currentState = { data: [], timeslots: [], adminPassword: null };
let editable = true; 
let isAdmin = false;

// ç›£è½è³‡æ–™
db.ref('/').on('value', (snapshot) => {
  const val = snapshot.val();
  document.getElementById("loading").style.display = "none";

  if (val) {
    currentState = val;
    if (!currentState.data) currentState.data = [];
    if (!currentState.timeslots) currentState.timeslots = [...defaultTimeslots];
    if (typeof currentState.editable !== 'undefined') editable = currentState.editable;
    
    // å¾è³‡æ–™åº«åŒæ­¥å¯†ç¢¼ (ä¸é è¨­å¯«æ­»)
    if (!currentState.adminPassword) currentState.adminPassword = null;
    
    normalizeDataArray();
    updateUI();
    renderTable();
    searchName();
  } else {
    document.querySelector("#loading div:last-child").textContent = "è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œæ­£åœ¨ä½¿ç”¨é è¨­å€¼ã€‚";
    // Set default values for currentState if the database is empty
    const now = new Date();
    currentState = {
        data: [],
        timeslots: [...defaultTimeslots],
        adminPassword: null, // No default admin password
        editable: true,      // Default to editable
        year: now.getFullYear(),
        month: now.getMonth() + 1, // JavaScript months are 0-indexed, so add 1
        C1: 1, // Default to Monday (0=Sunday, 1=Monday, ..., 6=Saturday)
        C2: 5  // Default to Friday
    };
    updateUI();
    renderTable();
    searchName();
  }
});

function normalizeDataArray() {
    if (!Array.isArray(currentState.data)) {
        let maxRow = -1;
        if (typeof currentState.data === 'object' && currentState.data !== null) {
            maxRow = Object.keys(currentState.data).reduce((a, b) => Math.max(a, parseInt(b)), -1);
        }
        
        let arr = [];
        for (let i = 0; i <= maxRow; i++) {
            let rowObj = currentState.data[i];
            if (rowObj) {
                if (Array.isArray(rowObj)) { arr[i] = rowObj; } 
                else if (typeof rowObj === 'object' && rowObj !== null) {
                    let maxCol = Object.keys(rowObj).reduce((a, b) => Math.max(a, parseInt(b)), -1);
                    let rowArr = [];
                    for(let j=0; j<=maxCol; j++) rowArr[j] = rowObj[j] || "";
                    arr[i] = rowArr;
                } else {
                    arr[i] = []; // If rowObj is not an array or object, treat as empty
                }
            } else { arr[i] = []; }
        }
        currentState.data = arr;
    }
}

function updateUI() {
    const y = currentState.year || "----";
    const m = currentState.month || "--";
    const w1 = typeof currentState.C1 !== 'undefined' ? weekdayName(currentState.C1) : "?";
    const w2 = typeof currentState.C2 !== 'undefined' ? weekdayName(currentState.C2) : "?";
    document.getElementById("current-date").innerHTML = `${y} å¹´ ${m} æœˆ &nbsp; <b>${w1} / ${w2}</b>`;
    
    const statusSpan = document.getElementById("system-status");
    statusSpan.className = "status-pill";
    if(isAdmin) {
        statusSpan.classList.add("pill-blue");
        statusSpan.textContent = "ç®¡ç†å“¡æ¨¡å¼";
        document.body.classList.add('admin-mode');
        document.getElementById("admin-btn").classList.add("btn-active");
        document.getElementById("admin-btn").textContent = "ç™»å‡º";
    } else if(editable) {
        statusSpan.classList.add("pill-green");
        statusSpan.textContent = "é–‹æ”¾é ç´„ä¸­";
        document.body.classList.remove('admin-mode');
        document.getElementById("admin-btn").classList.remove("btn-active");
        document.getElementById("admin-btn").textContent = "ç®¡ç†å“¡";
    } else {
        statusSpan.classList.add("pill-red");
        statusSpan.textContent = "ç³»çµ±å·²é–å®š";
        document.body.classList.remove('admin-mode');
        document.getElementById("admin-btn").classList.remove("btn-active");
        document.getElementById("admin-btn").textContent = "ç®¡ç†å“¡";
    }
}

function generateDates(year, month, C1, C2) { 
    const list = []; 
    if (!year || !month) return []; // Ensure year and month are valid
    let d = new Date(year, month - 1, 1); // month is 1-indexed for currentState, Date expects 0-indexed
    while (d.getMonth() === (month - 1)) { 
        if (d.getDay() === C1 || d.getDay() === C2) 
            list.push(`${d.getMonth()+1}/${d.getDate()} ${weekdayName(d.getDay())}`); 
        d.setDate(d.getDate() + 1); 
    } 
    return list; 
}

function renderTable() {
    // We now ensure currentState.year, month, C1, C2 have defaults, so this check is less critical but still good.
    if (!currentState.year || !currentState.month) {
        console.warn("Cannot render table: Missing year or month in currentState.");
        // Potentially render a message inside the table body instead of returning entirely
        // For now, let's allow it to render empty if these are missing, the generateDates will return empty list.
    }

    const dates = generateDates(currentState.year, currentState.month, currentState.C1, currentState.C2);
    const head = document.getElementById("headRow"); 
    const body = document.getElementById("bodyRows");
    
    head.innerHTML = "<th>æ™‚æ®µ</th>"; 
    dates.forEach(dt => { 
        const th = document.createElement("th"); 
        th.textContent = dt; 
        head.appendChild(th); 
    });

    body.innerHTML = "";
    const slots = currentState.timeslots || defaultTimeslots;
    
    if (dates.length === 0 && slots.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 1; // "æ™‚æ®µ" column
        td.textContent = "è«‹åœ¨ Firebase è³‡æ–™åº«ä¸­è¨­å®š 'year', 'month', 'C1', 'C2' å’Œ 'timeslots'ã€‚";
        td.style.textAlign = 'center';
        td.style.padding = '20px';
        tr.appendChild(td);
        body.appendChild(tr);
        return;
    } else if (dates.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 2; // "æ™‚æ®µ" column + placeholder for a date column
        td.textContent = "æ²’æœ‰æ—¥æœŸå¯ä»¥é¡¯ç¤ºã€‚è«‹æª¢æŸ¥ 'year', 'month', 'C1', 'C2' è¨­å®šã€‚";
        td.style.textAlign = 'center';
        td.style.padding = '20px';
        tr.appendChild(td);
        body.appendChild(tr);
        return;
    }


    slots.forEach((slot, r) => {
        const tr = document.createElement("tr"); 
        const tdSlot = document.createElement("td"); 
        tdSlot.textContent = slot; 
        tdSlot.className = "time-col";
        tr.appendChild(tdSlot);
        
        // Use dates.length for column count
        for (let c = 0; c < dates.length; c++) {
            const td = document.createElement("td"); 
            const rowData = currentState.data[r] || [];
            const val = rowData[c] || "";
            
            td.textContent = val;
            td.className = "slot";
            td.dataset.name = val; 

            if (val !== "") {
                td.classList.add("full"); 
            } else if (!editable) {
                td.classList.add("locked-sys"); 
            } else {
                td.classList.add("empty"); 
            }
            
            td.onclick = () => handleCellClick(r, c, val);
            tr.appendChild(td);
        } 
        body.appendChild(tr);
    });
}

function handleCellClick(r, c, currentVal) {
    if (!editable && !isAdmin && currentVal === "") {
        showToast("â›” ç³»çµ±ç›®å‰å·²é–å®š");
        return;
    }

    if (currentVal !== "" && !isAdmin) {
        showToast("âš ï¸ æ­¤æ™‚æ®µå·²è¢«é ç´„ï¼");
        return;
    }

    const defaultText = isAdmin ? "" : currentVal;
    const newName = prompt(isAdmin ? "ç®¡ç†å“¡ï¼šä¿®æ”¹/åˆªé™¤" : "è«‹è¼¸å…¥åå­—", defaultText);
    
    if (newName === null) return; 
    const finalName = newName.trim();
    if (finalName === currentVal) return; 

    if (finalName !== "" && !isAdmin) {
        let count = 0;
        if (currentState.data) {
            Object.values(currentState.data).forEach(row => {
                if (row) {
                    // Ensure row is an array before iterating with forEach, or handle objects
                    const rowAsArray = Array.isArray(row) ? row : Object.values(row);
                    rowAsArray.forEach(v => {
                        if (String(v || "").trim() === finalName) count++;
                    });
                }
            });
        }
        if (count >= 2) {
            showToast(`ğŸš« ${finalName} å·²ç¶“é ç´„ 2 æ¬¡äº†ï¼`);
            return;
        }
    }

    const cellRef = db.ref('data/' + r + '/' + c);
    cellRef.transaction((serverVal) => {
        if (isAdmin) return finalName; 
        if (finalName === "") return ""; 
        if (serverVal && serverVal !== "" && serverVal !== finalName) { return; } 
        return finalName;
    }, (error, committed, snapshot) => {
        if (error) { showToast("âŒ å¯«å…¥éŒ¯èª¤"); } 
        else if (!committed) {
            const actualName = snapshot.val();
            showToast(`âš ï¸ æ…¢äº†ä¸€æ­¥ï¼è¢« [ ${actualName} ] æ¶èµ°äº†`);
        } else {
            showToast("âœ… æ›´æ–°æˆåŠŸ");
        }
    });
}

function searchName() {
    const input = document.getElementById('searchInput').value.trim().toLowerCase();
    const cells = document.querySelectorAll('.slot');
    cells.forEach(cell => {
        const name = (cell.dataset.name || "").toLowerCase();
        if (input && name.includes(input)) {
            cell.classList.add('highlight');
        } else {
            cell.classList.remove('highlight');
        }
    });
}

function showToast(message) {
    const t = document.getElementById("toast");
    t.textContent = message;
    t.className = "show";
    setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
}

function toggleAdmin() {
    if (isAdmin) {
        isAdmin = false;
        showToast("ğŸ‘‹ å·²ç™»å‡º");
    } else {
        const pwd = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
        // é€™è£¡æœƒæ¯”å°è³‡æ–™åº«è£¡çš„å¯†ç¢¼ï¼Œå¦‚æœè³‡æ–™åº«æ²’è¨­å¯†ç¢¼ï¼Œé è¨­ç„¡æ³•ç™»å…¥
        if (currentState.adminPassword && pwd === currentState.adminPassword) {
            isAdmin = true;
            showToast("ğŸ”“ ç®¡ç†å“¡ç™»å…¥æˆåŠŸ");
        } else {
            showToast("âŒ å¯†ç¢¼éŒ¯èª¤");
        }
    }
    updateUI();
    renderTable();
}
</script>

</body>
</html>
